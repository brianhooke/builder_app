{% extends "master.html" %}

{% load humanize %}

{% block title %}
  Contract Admin
{% endblock %}


{% block content %}
<h1>Contract Admin Home Page</h1>
<p>65 Spitfire Place</p>

<!-- Add this inside your HTML where you want the button -->
<button id="commitCostsBtn">Commit Costs</button>
<input type="file" id="pdfInput" accept="application/pdf" style="display: none;" />

<form method="post" action="{% url 'upload_csv' %}" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Upload CSV</button>
</form>

<!-- Table to display Costing data -->
<div style="overflow-x:auto;">
  <table style="width:100%; border-collapse: collapse;">
    <thead>
      <tr style="background-image: linear-gradient(45deg, #A090D0 0%, #B3E1DD 100%);">
        <th>Category</th>
        <th>Item</th>
        <th>Contract Budget</th>
        <th>Forecast Budget</th>
        <th>Uncommitted</th>
        <th>Committed</th>
        <th>Complete On Site</th>
        <th>HC Next Claim</th>
        <th>HC Received</th>
        <th>SC Invoiced</th>
        <th>SC Paid</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      {% for costing in costings %}
      <tr>
        <td>{{ costing.category }}</td>
        <td>{{ costing.item }}</td>
        <td>{% if costing.contract_budget|floatformat:2 == "0.00" %}-{% else %}{{ costing.contract_budget|floatformat:2|intcomma }}{% endif %}</td>
            <!-- Forecast Budget calculation -->
        <td>{% with total=costing.committed|add:costing.uncommitted %}
          {% if total|floatformat:2 == "0.00" %}-{% else %}{{ total|floatformat:2|intcomma }}{% endif %}
        {% endwith %}</td>
        <td><a href="#" data-toggle="modal" data-target="#editModal{{ costing.id }}" data-id="{{ costing.id }}">{{ costing.uncommitted|floatformat:2|intcomma }}</a></td>
        <td><a href="#" data-toggle="modal" data-target="#editModal{{ costing.id }}" data-id="{{ costing.id }}">{{ costing.committed|floatformat:2|intcomma }}</a></td>
        <td>{% if costing.complete_on_site|floatformat:2 == "0.00" %}-{% else %}{{ costing.complete_on_site|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if costing.hc_next_claim|floatformat:2 == "0.00" %}-{% else %}{{ costing.hc_next_claim|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if costing.hc_received|floatformat:2 == "0.00" %}-{% else %}{{ costing.hc_received|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if costing.sc_invoiced|floatformat:2 == "0.00" %}-{% else %}{{ costing.sc_invoiced|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if costing.sc_paid|floatformat:2 == "0.00" %}-{% else %}{{ costing.sc_paid|floatformat:2|intcomma }}{% endif %}</td>
        <td>{{ costing.notes }}</td>
      </tr>
      {% endfor %}
      <!-- Total row -->
      <tr style="font-weight: bold;"> <!-- Make text bold -->
        <th>Total</th>
        <td>-</td> <!-- Placeholder for non-sum columns -->
        <td>{% if totals.total_contract_budget == 0 %}-{% else %}{{ totals.total_contract_budget|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_forecast_budget == 0 %}-{% else %}{{ totals.total_forecast_budget|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_uncommitted == 0 %}-{% else %}{{ totals.total_uncommitted|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_committed == 0 %}-{% else %}{{ totals.total_committed|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_complete_on_site == 0 %}-{% else %}{{ totals.total_complete_on_site|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_hc_next_claim == 0 %}-{% else %}{{ totals.total_hc_next_claim|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_hc_received == 0 %}-{% else %}{{ totals.total_hc_received|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_sc_invoiced == 0 %}-{% else %}{{ totals.total_sc_invoiced|floatformat:2|intcomma }}{% endif %}</td>
        <td>{% if totals.total_sc_paid == 0 %}-{% else %}{{ totals.total_sc_paid|floatformat:2|intcomma }}{% endif %}</td>
        <td>-</td> <!-- Placeholder for non-sum columns -->
      </tr>
    </tbody>
  </table>
</div>

{% for costing in costings %}
<!-- Modal -->
<div class="modal fade" id="editModal{{ costing.id }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel{{ costing.id }}" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel{{ costing.id }}">Edit Costs</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table>
          <!-- Existing costs -->
          <tr>
            <th></th>
            <th>Uncommitted</th>
            <th>Committed</th>
            <th>Total</th>
          </tr>
          <tr>
            <td>Original</td>
            <td>{{ costing.uncommitted|floatformat:2|intcomma }}</td>
            <td>{{ costing.committed|floatformat:2|intcomma }}</td>
            <td>{{ costing.committed|add:costing.uncommitted|floatformat:2|intcomma }}</td>
          </tr>
          <!-- Editable costs -->
          <tr>
            <td>Edited</td>
            <td><input type="number" class="form-control committed-input" id="uncommittedInput{{ costing.id }}" value="{{ costing.uncommitted }}"></td>
            <td><input type="number" class="form-control committed-input" id="committedInput{{ costing.id }}" value="{{ costing.committed }}"></td>
            <td id="total{{ costing.id }}">{{ costing.committed|add:costing.uncommitted|floatformat:2|intcomma }}</td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary save-costs" data-id="{{ costing.id }}">Save</button>
    </div>    
    </div>
  </div>
</div>

{% endfor %}
{{ items|json_script:"items-data" }}

<script>
  var itemsData = JSON.parse(document.getElementById('items-data').textContent);

document.addEventListener('DOMContentLoaded', function() {
    // Handler for 'Commit Costs' button to open the PDF input
    document.getElementById('commitCostsBtn').addEventListener('click', function() {
        document.getElementById('pdfInput').click();
    });

    // Handler for file input change event
    document.getElementById('pdfInput').addEventListener('change', function(event) {
        var file = event.target.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var pdfData = e.target.result;
                displayCombinedModal(pdfData);
            };
            reader.readAsDataURL(file);
        }
    });
});

// Function to display the combined modal
function displayCombinedModal(pdfData) {
    var combinedModalHTML = `
        <div id="combinedModal" style="position: fixed; top: 10%; left: 170px; width: calc(100% - 170px); height: 80%; background-color: white; padding: 20px; border: 1px solid #ddd; display: flex; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);">
            <div style="flex: 1; border-right: 1px solid #ddd; padding-right: 10px;">
                <iframe src="${pdfData}" width="100%" height="100%" style="border: none;"></iframe>
            </div>
            <div style="flex: 1; padding-left: 10px; overflow-x: auto;">">
                <h2>Commit Costs</h2>
                <label for="totalCost">Total Cost:</label>
                <input type="number" id="totalCost" step="0.01" placeholder="0.00" style="margin-bottom: 10px;">
                <h3>Line Items</h3>
                <table id="lineItemsTable">
                    <thead>
                        <tr>
                            <th rowspan="2">Item</th>
                            <th colspan="2">Uncommitted</th>
                            <th colspan="2">Committed</th>
                            <th colspan="2">Total</th>
                        </tr>
                        <tr>
                            <th>Old</th>
                            <th>New</th>
                            <th>Old</th>
                            <th>New</th>
                            <th>Old</th>
                            <th>New</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be added here -->
                    </tbody>
                </table>
                <button id="addRowButton" onclick="addLineItem()">+</button>
                <button id="closeBtn">Close</button>
            </div>
        </div>
    `;
    // Create a new div and set its innerHTML to the modal HTML
    var modalDiv = document.createElement('div');
    modalDiv.innerHTML = combinedModalHTML;
    // Append the div to the body
    document.body.appendChild(modalDiv);
    // Set up 'close' button event listener
    document.getElementById('closeBtn').addEventListener('click', function() {
        var modal = document.getElementById('combinedModal');
        modal.parentNode.removeChild(modal);

        // Reset the file input
        document.getElementById('pdfInput').value = '';
    });
}

// Function to add a new line item
function addLineItem() {
    var table = document.getElementById('lineItemsTable');
    var row = table.insertRow(-1);
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    var cell6 = row.insertCell(5);
    var cell7 = row.insertCell(6);

    cell1.innerHTML = '<select id="itemSelect"></select>';
    cell2.innerHTML = '<input type="number" step="0.01" placeholder="0.00">';
    cell3.innerHTML = '<input type="number" step="0.01" placeholder="0.00">';
    cell4.innerHTML = '<input type="number" step="0.01" placeholder="0.00">';
    cell5.innerHTML = '<input type="number" step="0.01" placeholder="0.00">';
    cell6.innerHTML = '<input type="number" step="0.01" placeholder="0.00">';
    cell7.innerHTML = '<input type="number" step="0.01" placeholder="0.00">';

    // Populate the select options
    var select = document.getElementById('itemSelect');
    for (var i = 0; i < itemsData.length; i++) {
        var option = document.createElement('option');
        option.value = itemsData[i].id;
        option.text = itemsData[i].name;
        select.appendChild(option);
    }
}

// Function to calculate the total cost
function calculateTotalCost() {
    var totalCostInput = document.getElementById('totalCost');
    var table = document.getElementById('lineItemsTable');
    var totalCost = 0;
    for (var i = 1, row; row = table.rows[i]; i++) {
        //iterate through rows
        //rows would be accessed using the "row" variable assigned in the for loop
        for (var j = 0, col; col = row.cells[j]; j++) {
            //iterate through columns
            //columns would be accessed using the "col" variable assigned in the for loop
            if (j == 1 || j == 3 || j == 5 || j == 7 || j == 9 || j == 11 || j == 13) {
                totalCost += parseFloat(col.children[0].value);
            }
        }  
    }
    totalCostInput.value = totalCost.toFixed(2);
}

// Add event listener to the 'add row' button
document.getElementById('addRowButton').addEventListener('click', function() {
    addLineItem();
    calculateTotalCost();
});

// Add event listener to the 'total cost' input
document.getElementById('totalCost').addEventListener('input', function() {
    calculateTotalCost();
});

</script>

  
{% endblock %}

